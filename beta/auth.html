<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConciergeSync — Sign in / Register</title>
  <style>
    :root{
      --card:#fff; --ink:#0f172a; --muted:#475569; --bg:#f6f7fb; --accent:#111;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --ring: 0 0 0 3px rgba(17,17,17,.15);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--ink);}

    .wrap{max-width:920px; margin:40px auto; padding:0 20px;}
    .card{background:var(--card); border:1px solid #e6eaf0; border-radius:16px; box-shadow:0 6px 24px rgba(15,23,42,.06); padding:28px;}
    h1{font-size:28px; margin:0 0 8px; text-align:center}
    p.lead{color:var(--muted); text-align:center; margin:0 0 20px}

    .switch{display:flex; gap:8px; justify-content:center; margin:12px 0 22px}
    .switch button{
      padding:10px 14px; border-radius:12px; border:1px solid #dbe1ea; background:#fff; cursor:pointer; font-weight:600;
    }
    .switch button.active{background:#111; color:#fff; border-color:#111}

    form{display:grid; gap:12px; max-width:520px; margin:0 auto}
    label{font-weight:600; font-size:14px}
    input[type="email"], input[type="text"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #dbe1ea; font-size:16px;
    }
    input:focus{outline:none; box-shadow:var(--ring); border-color:#bbb}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .actions{display:flex; gap:10px; align-items:center; margin-top:6px}
    .btn{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      padding:12px 16px; border-radius:12px; border:1px solid #111; background:#111; color:#fff; font-weight:700; cursor:pointer;
    }
    .btn.secondary{background:#fff; color:#111}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    /* OTP boxes */
    .otp{display:flex; gap:8px; justify-content:center; margin-top:8px}
    .otp input{
      width:46px; height:52px; text-align:center; font-size:22px; border-radius:12px; border:1px solid #dbe1ea;
    }

    .hint{color:var(--muted); font-size:13px}
    .error{color:var(--err); font-weight:600; font-size:14px}
    .ok{color:var(--ok); font-weight:600; font-size:14px}

    .sep{height:1px; background:#eef1f6; margin:16px 0}

    .legal{color:#6b7280; font-size:12px; text-align:center; margin-top:8px}
    .a{color:#111; text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Welcome back 👋</h1>
      <p class="lead">Sign in or create your account with your email.</p>

      <div class="switch" role="tablist" aria-label="Auth mode">
        <button id="tab-login"  class="active" aria-selected="true">Returning user? Log in</button>
        <button id="tab-register" aria-selected="false">New user? Register</button>
      </div>

      <!-- LOGIN -->
      <form id="form-login" autocomplete="on">
        <div>
          <label for="login-email">Email</label>
          <input id="login-email" name="email" type="email" inputmode="email" autocomplete="email"
                 placeholder="you@example.com" required />
        </div>
        <div class="actions">
          <button class="btn" id="btn-send-code" type="submit">Send sign-in code</button>
          <button class="btn secondary" id="btn-use-link" type="button" title="Sends a one-time magic link instead of a 6-digit code">Email me a magic link</button>
          <span id="login-msg" class="hint" aria-live="polite"></span>
        </div>

        <!-- OTP step (hidden until a code is sent) -->
        <div id="otp-wrap" style="display:none">
          <div class="sep"></div>
          <label>Enter the 6-digit code sent to your email</label>
          <div class="otp" id="otp-boxes" aria-label="One-time passcode">
            <input maxlength="1" inputmode="numeric" pattern="[0-9]*" />
            <input maxlength="1" inputmode="numeric" pattern="[0-9]*" />
            <input maxlength="1" inputmode="numeric" pattern="[0-9]*" />
            <input maxlength="1" inputmode="numeric" pattern="[0-9]*" />
            <input maxlength="1" inputmode="numeric" pattern="[0-9]*" />
            <input maxlength="1" inputmode="numeric" pattern="[0-9]*" />
          </div>
          <div class="actions">
            <button class="btn" id="btn-verify" type="button">Verify &amp; continue</button>
            <button class="btn secondary" id="btn-resend" type="button">Resend code</button>
            <span id="otp-msg" class="hint" aria-live="polite"></span>
          </div>
        </div>
      </form>

      <!-- REGISTER -->
      <form id="form-register" style="display:none" autocomplete="on">
        <div class="row">
          <div>
            <label for="reg-first">First name</label>
            <input id="reg-first" name="firstName" type="text" autocomplete="given-name" />
          </div>
          <div>
            <label for="reg-last">Last name</label>
            <input id="reg-last" name="lastName" type="text" autocomplete="family-name" />
          </div>
        </div>
        <div>
          <label for="reg-email">Email (your LoginID)</label>
          <input id="reg-email" name="email" type="email" inputmode="email" autocomplete="email"
                 placeholder="you@example.com" required />
        </div>
        <div>
          <label><input id="reg-tos" type="checkbox" required /> I agree to the <a class="a" href="/legal/terms.html" target="_blank" rel="noopener">Terms</a> &amp; <a class="a" href="/legal/privacy.html" target="_blank" rel="noopener">Privacy</a>.</label>
        </div>

        <div class="actions">
          <button class="btn" id="btn-register" type="submit">Create account</button>
          <span id="reg-msg" class="hint" aria-live="polite"></span>
        </div>

        <!-- Optional: send them to a NoteForms registration form after account creation -->
        <p class="legal">Prefer a full form? <a id="nf-link" class="a" href="#" target="_blank" rel="noopener">Open registration form</a></p>
      </form>

      <p class="legal">Protected by rate-limiting and verification. We’ll never share your email.</p>
    </div>
  </div>

  <script>
    // ========= CONFIG (adjust for your stack) ============================
    // Your backend endpoints (email-based auth)
    const API = {
      start:  '/api/auth/start',    // POST { mode:'login'|'register'|'link', email }
      verify: '/api/auth/verify',   // POST { tokenId, code }
    };
    // After successful auth:
    const REDIRECT_AFTER_LOGIN = '/beta/02-agree.html';

    // Optional: NoteForms registration URL (stores extra profile in Notion)
    // Replace with your NoteForms share URL. Most form tools accept prefill via ?email=...
    const NOTEFORMS_URL = 'https://noteforms.example.com/your-form-id'; // ← change me
    // ====================================================================

    const $ = (sel, root=document) => root.querySelector(sel);

    // Tabs
    const tabLogin = $('#tab-login');
    const tabReg   = $('#tab-register');
    const formLogin = $('#form-login');
    const formReg   = $('#form-register');

    function setMode(mode){
      const login = (mode==='login');
      tabLogin.classList.toggle('active', login);
      tabReg.classList.toggle('active', !login);
      formLogin.style.display = login ? '' : 'none';
      formReg.style.display   = login ? 'none' : '';
      (login?$('#login-email'):$('#reg-email'))?.focus();
    }
    tabLogin.addEventListener('click', ()=>setMode('login'));
    tabReg.addEventListener('click',   ()=>setMode('register'));

    // Prefill NoteForms link with email when available
    function setNoteFormsHref(){
      const email = ($('#reg-email').value || '').trim();
      const url = new URL(NOTEFORMS_URL);
      if (email) url.searchParams.set('email', email);
      $('#nf-link').href = url.toString();
    }
    $('#reg-email').addEventListener('input', setNoteFormsHref);
    setNoteFormsHref();

    // ---- LOGIN (magic code or magic link) --------------------------------
    const otpWrap = $('#otp-wrap');
    const otpBoxes = Array.from($('#otp-boxes').querySelectorAll('input'));
    const loginMsg = $('#login-msg');
    const otpMsg = $('#otp-msg');
    let tokenId = null; // returned by /auth/start for OTP flow

    // Send code
    formLogin.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = ($('#login-email').value || '').trim();
      if (!email) return;

      loginMsg.textContent = 'Sending code…';
      $('#btn-send-code').disabled = true;
      try{
        const res = await fetch(API.start, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode:'login', email })
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) throw new Error(data?.error || 'Failed to send code');
        tokenId = data.tokenId; // server associates this with the emailed code
        otpWrap.style.display = '';
        loginMsg.textContent = 'Check your email for a 6-digit code.';
        otpBoxes[0].focus();
      }catch(err){
        loginMsg.textContent = '';
        alert(err.message || 'Could not send code');
      }finally{
        $('#btn-send-code').disabled = false;
      }
    });

    // Magic link
    $('#btn-use-link').addEventListener('click', async ()=>{
      const email = ($('#login-email').value || '').trim();
      if (!email) return alert('Enter your email first.');
      loginMsg.textContent = 'Sending magic link…';
      try{
        const res = await fetch(API.start, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode:'link', email })
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) throw new Error(data?.error || 'Failed to send link');
        loginMsg.textContent = 'Magic link sent — check your inbox.';
      }catch(err){
        loginMsg.textContent = '';
        alert(err.message || 'Could not send link');
      }
    });

    // OTP UX (auto-advance, backspace)
    otpBoxes.forEach((box, i) => {
      box.addEventListener('input', (e)=>{
        const v = box.value.replace(/\D/g,'');
        box.value = v.slice(-1);
        if (v && i < otpBoxes.length-1) otpBoxes[i+1].focus();
      });
      box.addEventListener('keydown', (e)=>{
        if (e.key === 'Backspace' && !box.value && i>0) otpBoxes[i-1].focus();
      });
    });

    // Verify code
    $('#btn-verify').addEventListener('click', async ()=>{
      const email = ($('#login-email').value || '').trim();
      const code = otpBoxes.map(b=>b.value).join('');
      if (!tokenId || code.length !== 6) return;

      otpMsg.textContent = 'Verifying…';
      try{
        const res = await fetch(API.verify, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tokenId, code })
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) throw new Error(data?.error || 'Invalid code');
        // server should set a secure session cookie; then redirect
        location.assign(REDIRECT_AFTER_LOGIN);
      }catch(err){
        otpMsg.textContent = '';
        alert(err.message || 'Could not verify code');
      }
    });

    // Resend code
    $('#btn-resend').addEventListener('click', async ()=>{
      const email = ($('#login-email').value || '').trim();
      if (!email) return;
      loginMsg.textContent = 'Resending code…';
      try{
        const res = await fetch(API.start, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode:'login', email })
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) throw new Error(data?.error || 'Failed to resend code');
        tokenId = data.tokenId;
        loginMsg.textContent = 'New code sent.';
      }catch(err){
        loginMsg.textContent = '';
        alert(err.message || 'Could not resend code');
      }
    });

    // ---- REGISTER --------------------------------------------------------
    formReg.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const firstName = ($('#reg-first').value || '').trim();
      const lastName  = ($('#reg-last').value || '').trim();
      const email     = ($('#reg-email').value || '').trim();
      const agree     = $('#reg-tos').checked;

      if (!email || !agree) return;

      $('#btn-register').disabled = true;
      $('#reg-msg').textContent = 'Creating your account…';

      try{
        // 1) create the auth identity
        const res = await fetch(API.start, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode:'register', email, profile:{ firstName, lastName } })
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) throw new Error(data?.error || 'Could not create account');

        // 2) Optionally push extra profile to Notion via NoteForms webhook on your backend.
        //    (Alternatively open the NoteForms page in a new tab for the user to complete.)
        setNoteFormsHref();

        // 3) If your backend sends a login code automatically, show the OTP UI now:
        tokenId = data.tokenId ?? null;
        if (tokenId){
          otpWrap.style.display = '';
          $('#login-email').value = email; // so OTP verifies the same email
          setMode('login');
          $('#login-msg').textContent = 'We emailed you a sign-in code to complete setup.';
          otpBoxes[0].focus();
        }else{
          // or just say: check your email for a magic link to finish.
          location.assign(REDIRECT_AFTER_LOGIN);
        }
      }catch(err){
        alert(err.message || 'Registration failed');
      }finally{
        $('#btn-register').disabled = false;
        $('#reg-msg').textContent = '';
      }
    });

    // Deep link: /beta/auth.html#register → open Register tab
    if (location.hash === '#register') setMode('register');
  </script>
</body>
</html>
