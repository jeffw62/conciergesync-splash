<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Before We Begin — ConciergeSync™ Beta Agreement</title>
  <style>
    :root{
      --page-bg:#0b0f14;
      --ink:#eaf2ff; --muted:#9fb0c8;
      --glass-bg:rgba(255,255,255,.10);
      --glass-brd:rgba(255,255,255,.22);
      --glass-blur:blur(14px) saturate(1.1);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:var(--page-bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center;
      padding:24px; position:relative; overflow:auto;
    }

    /* Gold logo background (vibrant; no dimming overlay) */
    .cs-bg{
      position:fixed; inset:0; z-index:-2;
      background:url('/beta/assets/CS_Logo_Premium.png') center/500px repeat;
      opacity:.75; pointer-events:none;
      filter:contrast(1.06) saturate(1.05) brightness(1.03);
    }

    /* Glass tile — fixed 500px (responsive down) */
    .tile{
      width:min(500px,95vw);
      border-radius:20px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      box-shadow:0 18px 48px rgba(0,0,0,.45), inset 0 0 0 1px var(--glass-brd);
      padding:20px 18px 22px;
    }

    .title{
      margin:0 0 8px; font-size:clamp(18px,2.6vw,22px);
      font-weight:800; letter-spacing:-.01em; text-align:center;
    }
    .intro{
      margin:6px auto 14px; max-width:56ch; text-align:center;
      color:#e8edf7; font-size:14px; line-height:1.55;
    }

    /* Scrollable terms */
    .scroll-box{
      height:44vh; min-height:300px; max-height:520px;
      overflow:auto; padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.30);
      color:#f5f8ff; line-height:1.55;
    }
    .scroll-box h2{ margin:0 0 8px; font-size:18px }
    .scroll-box h3{ margin:14px 0 6px; font-size:15px }
    .scroll-box p, .scroll-box ul{ margin:8px 0; font-size:14px; color:#e8edf7 }
    .scroll-box ul{ padding-left:18px }

    .actions{
      margin-top:16px; display:flex; justify-content:center; gap:10px; align-items:center;
    }
    .cta{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 16px; border-radius:999px; font-weight:800;
      color:#111; background:#fff; border:1px solid #fff; text-decoration:none;
      transition:transform .06s ease, box-shadow .2s ease, opacity .2s ease;
      box-shadow:0 4px 18px rgba(0,0,0,.25); cursor:pointer; font-size:14px;
    }
    .cta:active{ transform:translateY(1px) }
    .cta[disabled]{ opacity:.45; cursor:not-allowed }
    .cta.ghost{
      background:rgba(0,0,0,.35); border-color:rgba(255,255,255,.35); color:#fff; box-shadow:none;
    }

    .sub{ text-align:center; margin-top:8px; color:rgba(255,255,255,.75); font-size:12px }
    .warn{ display:none; margin:10px 0 0; text-align:center; color:#ffd7a8; font-size:13px }
  </style>
</head>
<body>
  <div class="cs-bg"></div>

  <main class="tile" role="main" aria-labelledby="page-title">
    <h1 id="page-title" class="title">Before We Begin…</h1>
    <p class="intro">
      Please review the Terms &amp; Conditions and Privacy Policy below.
      Scroll to the bottom to unlock <strong>“I Agree — Continue”</strong>.
    </p>

    <section id="termsBox" class="scroll-box" tabindex="0" aria-label="Terms and Privacy scroll box">
      <!-- Replace with your full legal text -->
      <h2>Terms &amp; Conditions — ConciergeSync™</h2>
      <p><em>Last updated: 8/13/2025</em></p>
      <p>By accessing and using the ConciergeSync™ beta program, you agree to be bound by the following terms and conditions:</p>
      <ul>
        <li>The beta may contain bugs or incomplete features.</li>
        <li>Do not share screenshots, data, or access with non-authorized individuals.</li>
        <li>Features/services may change at any time without notice during the beta.</li>
        <li>You retain ownership of your data; we may analyze anonymized usage to improve the service.</li>
        <li>We aren’t responsible for losses from actions you take based on beta recommendations.</li>
      </ul>
      <hr/>
      <h2>Privacy Policy — ConciergeSync™</h2>
      <p><em>Last updated: 8/13/2025</em></p>
      <h3>What We Collect</h3>
      <ul>
        <li>Name and email during onboarding.</li>
        <li>Answers to intake forms, trip evaluations, and preferences.</li>
        <li>Technical data (browser, device info, IP-derived region) to improve performance.</li>
      </ul>
      <h3>How We Use It</h3>
      <ul>
        <li>To personalize the beta experience and optimize the product.</li>
        <li>To analyze usage patterns and refine platform logic.</li>
        <li>To send essential updates or feedback requests (no spam).</li>
      </ul>
      <h3>Your Rights</h3>
      <p>To access, modify, or delete your data, email <strong>privacy@conciergesync.ai</strong>. We do not sell your data.</p>
    </section>

    <div class="actions">
      <button id="agreeBtn" class="cta" type="button">I Agree — Continue</button>
      <a id="declineBtn" class="cta ghost" href="#">I Decline</a>
    </div>

    <div id="missingEmail" class="warn">
      We couldn’t confirm your email. <a href="/beta/auth.html" style="color:#fff;text-decoration:underline">Return to registration</a>.
    </div>

    <div class="sub">Solving what matters — Beautifully</div>
  </main>

  <!-- UI logic (plain script: runs even if module imports fail) -->
  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      let email = (qs.get("email") || sessionStorage.getItem("cs_email") || localStorage.getItem("cs_email") || "").toLowerCase().trim();
      if (email) { try { sessionStorage.setItem("cs_email", email); localStorage.setItem("cs_email", email); } catch(e){} }

      const NEXT = "/beta/03-intake-start.html";

      const box        = document.getElementById("termsBox");
      const agreeBtn   = document.getElementById("agreeBtn");
      const declineBtn = document.getElementById("declineBtn");
      const missingEl  = document.getElementById("missingEmail");

      // --- Enable "I agree" only after reaching the bottom of #termsBox ---
      function enableAgree(){ agreeBtn.disabled = false; agreeBtn.removeAttribute("aria-disabled"); }
      function disableAgree(){ agreeBtn.disabled = true;  agreeBtn.setAttribute("aria-disabled","true"); }

      // start disabled; also require known email
      disableAgree();

      // Sentinel approach + scroll math fallback + small timeout safety
      const sentinel = document.createElement("div");
      sentinel.setAttribute("aria-hidden","true");
      sentinel.style.height = "1px";
      box.appendChild(sentinel);

      let io;
      if ('IntersectionObserver' in window) {
        io = new IntersectionObserver(
          (entries) => {
            const vis = entries.some(e => e.isIntersecting);
            if (vis && email) enableAgree(); else disableAgree();
          },
          { root: box, threshold: [0, 0.5, 1] }
        );
        io.observe(sentinel);
      }

      function checkBottomFallback(){
        const atBottom = Math.ceil(box.scrollTop + box.clientHeight) >= (box.scrollHeight - 1);
        if (atBottom && email) enableAgree(); else disableAgree();
      }
      box.addEventListener("scroll", checkBottomFallback);
      window.addEventListener("load", () => {
        if (!email) missingEl.style.display = "block";
        checkBottomFallback();
        // If content is short / no scroll, enable after a brief delay
        setTimeout(checkBottomFallback, 100);
      });

      // Agree: call Firestore write if available, then continue
      agreeBtn.addEventListener("click", async (e)=>{
        if (agreeBtn.disabled) { e.preventDefault(); return; }

        try { localStorage.setItem("cs_agreed","1"); } catch(e){}
        try {
          if (typeof window.csWriteConsent === "function") {
            await window.csWriteConsent(email);
          } else {
            console.warn("Consent writer not ready; proceeding without server record.");
          }
        } catch(err) {
          console.warn("Consent write failed; proceeding anyway.", err);
        }
        location.replace(NEXT + (location.search || ""));
      });

      // Decline → TCP-Decline.html (carry params)
      declineBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        const out = new URLSearchParams(location.search);
        if (email && !out.get("email")) out.set("email", email);
        out.set("declined","1");
        location.replace("/beta/TCP-Decline.html?" + out.toString());
      });
    })();
  </script>

  <!-- Firestore write (module). If this fails to load, UI still works. -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcqBQtV3e1hGRMzBa_k5trNRqL0UmlByE",
      authDomain: "conciergesync.firebaseapp.com",
      projectId: "conciergesync",
      storageBucket: "conciergesync.appspot.com",
      messagingSenderId: "882907448780",
      appId: "1:882907448780:web:6e797ce9ad5bb84a9f8969"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const TERMS_VERSION = "2025-08-28";

    // Expose a tiny writer the plain script can call
    window.csWriteConsent = async function(email){
      if (!email) throw new Error("Missing email");
      const ref  = doc(db, "beta_users", email);
      const snap = await getDoc(ref);
      const base = snap.exists() ? {} : { email, createdAt: serverTimestamp() };
      await setDoc(ref, {
        ...base,
        agreed: true,
        agreedAt: serverTimestamp(),
        termsVersion: TERMS_VERSION,
        updatedAt: serverTimestamp()
      }, { merge: true });
    };
  </script>
</body>
</html>
